require("dotenv").config();const{OS_NAME:OS_NAME}=process.env,{createSticker:createSticker,StickerTypes:StickerTypes}=require("wa-sticker-formatter"),{getMessageById:getMessageById}=require("../db.repository/messages.repository"),{MessageTypes:MessageTypes,LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("./message.type"),{isUrl:isUrl,isImage:isImage,isVideo:isVideo,isAudio:isAudio}=require("./common.util"),MessageMedia=require("./message.media"),generateMessageId=()=>(new Date).getTime().toString(36)+Math.random().toString(36).slice(2),isRegisteredUser=async(e,s)=>{try{const[t]=await s.onWhatsApp(e);if(t)return t.exists}catch(e){console.log("error ...."),console.log(e)}return!1},sendTextAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await a.sendMessage(e,{text:s,mentions:t}),{key:i}=o;return i&&(n=i.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendContactAsync=async(e,s,t)=>{let a=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,t)){let n=[];for(const e of s.vcards)n.push({vcard:e});const o=await t.sendMessage(e,{contacts:{contacts:n}}),{key:i}=o;return i&&(a=i.id),`true_${e}_${s}_${a}`}return`false_${e}_${s}_${a}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${a}`},replyAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await getMessageById(t);if(!o)return`false_${e}_${s}_${n}`;const i=JSON.parse(o);if(!i)return`false_${e}_${s}_${n}`;const r=getLegacyMessageType(i);let c=void 0;r===LegacyMessageTypes.CONVERSATION?c={conversation:i.message.conversation}:r===LegacyMessageTypes.IMAGE_MESSAGE?c=i.message.imageMessage.caption?{imageMessage:{mimetype:i.message.imageMessage.mimetype,caption:i.message.imageMessage.caption}}:{imageMessage:{mimetype:i.message.imageMessage.mimetype}}:r===LegacyMessageTypes.DOCUMENT_MESSAGE?c={documentMessage:{mimetype:i.message.documentMessage.mimetype,title:i.message.documentMessage.title}}:r===LegacyMessageTypes.VIDEO_MESSAGE?c={videoMessage:{mimetype:i.message.videoMessage.mimetype,fileSha256:i.message.videoMessage.fileSha256}}:r===LegacyMessageTypes.LOCATION_MESSAGE?c={locationMessage:{degreesLatitude:i.message.locationMessage.degreesLatitude,degreesLongitude:i.message.locationMessage.degreesLongitude}}:r===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?c={buttonsResponseMessage:{selectedButtonId:i.message.buttonsResponseMessage.selectedButtonId,selectedDisplayText:i.message.buttonsResponseMessage.selectedDisplayText}}:r===LegacyMessageTypes.LIST_RESPONSE_MESSAGE?c={listResponseMessage:{title:i.message.listResponseMessage.title}}:r===LegacyMessageTypes.CONTACT_MESSAGE?c={contactMessage:{displayName:i.message.contactMessage.displayName}}:r===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&(c={contactsArrayMessage:{displayName:i.message.contactsArrayMessage.displayName}});const g={key:i.key,message:c},d=await a.sendMessage(e,{text:s},{quoted:g}),{key:l}=d;return l&&(t=l.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},replyStickerAsync=async(e,s,t,a)=>{let n=generateMessageId();try{const o=!!e.endsWith("@g.us")||await isRegisteredUser(e,a),i="reply with sticker";if(o){const o=await getMessageById(t);if(!o)return`false_${e}_${i}_${n}`;const r=JSON.parse(o);if(!r)return`false_${e}_${i}_${n}`;const c=getLegacyMessageType(r);let g=void 0;c===LegacyMessageTypes.CONVERSATION?g={conversation:r.message.conversation}:c===LegacyMessageTypes.IMAGE_MESSAGE?g=r.message.imageMessage.caption?{imageMessage:{mimetype:r.message.imageMessage.mimetype,caption:r.message.imageMessage.caption}}:{imageMessage:{mimetype:r.message.imageMessage.mimetype}}:c===LegacyMessageTypes.DOCUMENT_MESSAGE?g={documentMessage:{mimetype:r.message.documentMessage.mimetype,title:r.message.documentMessage.title}}:c===LegacyMessageTypes.VIDEO_MESSAGE?g={videoMessage:{mimetype:r.message.videoMessage.mimetype,fileSha256:r.message.videoMessage.fileSha256}}:c===LegacyMessageTypes.LOCATION_MESSAGE?g={locationMessage:{degreesLatitude:r.message.locationMessage.degreesLatitude,degreesLongitude:r.message.locationMessage.degreesLongitude}}:c===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?g={buttonsResponseMessage:{selectedButtonId:r.message.buttonsResponseMessage.selectedButtonId,selectedDisplayText:r.message.buttonsResponseMessage.selectedDisplayText}}:c===LegacyMessageTypes.LIST_RESPONSE_MESSAGE?g={listResponseMessage:{title:r.message.listResponseMessage.title}}:c===LegacyMessageTypes.CONTACT_MESSAGE?g={contactMessage:{displayName:r.message.contactMessage.displayName}}:c===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&(g={contactsArrayMessage:{displayName:r.message.contactsArrayMessage.displayName}});const d={key:r.key,message:g},l={pack:s.packName,author:s.author,type:StickerTypes.FULL,quality:s.quality},y=s.attachmentOrUrl,u=isUrl(y)?await MessageMedia.fromUrl(y):MessageMedia.fromFilePath(y),m=await createSticker(u.data,l),_=await a.sendMessage(e,{sticker:m},{quoted:d}),{key:M}=_;return M&&(t=M.id),`true_${e}_${i}_${n}`}return`false_${e}_${i}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${message}_${n}`},sendStickerAsync=async(e,s,t)=>{let a=generateMessageId();try{const n=!!e.endsWith("@g.us")||await isRegisteredUser(e,t),o="send sticker";if(n){const n={pack:s.packName,author:s.author,type:StickerTypes.FULL,quality:s.quality},i=s.attachmentOrUrl,r=isUrl(i)?await MessageMedia.fromUrl(i):MessageMedia.fromFilePath(i),c=await createSticker(r.data,n),g=await t.sendMessage(e,{sticker:c}),{key:d}=g;return d&&(a=d.id),`true_${e}_${o}_${a}`}return`false_${e}_${o}_${a}`}catch(e){console.log(e)}return`false_${e}_${caption}_${a}`},sendImageAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const i=await n.sendMessage(e,{image:{url:s},caption:t||void 0,mentions:a}),{key:r}=i;return r&&(o=r.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendGifAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const i=await n.sendMessage(e,{video:{url:s},caption:t||void 0,gifPlayback:!0,mentions:a}),{key:r}=i;return r&&(o=r.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendVideoAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const i=await n.sendMessage(e,{video:{url:s},caption:t||void 0,mentions:a}),{key:r}=i;return r&&(o=r.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendAudioAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const a="Android"==(OS_NAME||"Android")?"audio/mp4":"audio/mpeg",i=await n.sendMessage(e,{audio:{url:s},mimetype:a}),{key:r}=i;return r&&(o=r.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendDocumentAsync=async(e,s,t,a,n)=>{let o=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,n)){const i=isUrl(s)?await MessageMedia.fromUrl(s):MessageMedia.fromFilePath(s),r=i.mimetype,c=i.filename,g=await n.sendMessage(e,{document:{url:s},mimetype:r,fileName:c,caption:t||void 0,mentions:a}),{key:d}=g;return d&&(o=d.id),`true_${e}_${t}_${o}`}return`false_${e}_${t}_${o}`}catch(e){console.log(e)}return`false_${e}_${t}_${o}`},sendLocationAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){const o=await a.sendMessage(e,{location:s,mentions:t}),{key:i}=o;return i&&(n=i.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendListAsync=async(e,s,t)=>{let a=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,t)){let n=[];for(const e of s.sections){let s=[];for(const t of e.rows)s.push({rowId:t.id,title:t.title,description:t.description});const t={title:e.title,rows:s};n.push(t)}const o={text:s.content,footer:s.footer,title:s.title,buttonText:s.listText,sections:n},i=await t.sendMessage(e,o),{key:r}=i;return r&&(a=r.id),`true_${e}_${s}_${a}`}return`false_${e}_${s}_${a}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${a}`},sendButtonAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){let o=[];for(const e of s.items){const s={buttonId:e.id,buttonText:{displayText:e.body},type:1};o.push(s)}let i=void 0;if(t){const e=isUrl(t)?await MessageMedia.fromUrl(t):MessageMedia.fromFilePath(t),a=e.mimetype,n=e.filename;i=isImage(a)?{image:{url:t},caption:s.content,footer:s.footer,buttons:o,headerType:4}:isVideo(a)?{video:{url:t},caption:s.content,footer:s.footer,buttons:o,headerType:4}:isAudio(a)?{audio:{url:t},caption:s.content,footer:s.footer,buttons:o,headerType:4}:{document:{url:t},mimetype:a,fileName:n,footer:s.footer,buttons:o,headerType:4}}else i={text:s.content,footer:s.footer,buttons:o,headerType:1};const r=await a.sendMessage(e,i),{key:c}=r;return c&&(n=c.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`},sendButtonCTAAsync=async(e,s,t,a)=>{let n=generateMessageId();try{if(!!e.endsWith("@g.us")||await isRegisteredUser(e,a)){let o=[];for(const e of s.items){let s=void 0;if(e.urlButton){const t=e.urlButton;s={index:e.index,urlButton:{displayText:t.body,url:t.url}}}else if(e.callButton){const t=e.callButton;s={index:e.index,callButton:{displayText:t.body,phoneNumber:t.phoneNumber}}}else if(e.quickReplyButton){const t=e.quickReplyButton;s={index:e.index,quickReplyButton:{displayText:t.body,id:t.id}}}o.push(s)}let i=void 0;if(t){const e=isUrl(t)?await MessageMedia.fromUrl(t):MessageMedia.fromFilePath(t),a=e.mimetype,n=e.filename;i=isImage(a)?{caption:s.content,footer:s.footer,templateButtons:o,image:{url:t}}:isVideo(a)?{caption:s.content,footer:s.footer,templateButtons:o,video:{url:t}}:isAudio(a)?{caption:s.content,footer:s.footer,templateButtons:o,audio:{url:t}}:{caption:s.content,footer:s.footer,templateButtons:o,document:{url:t},mimetype:a,fileName:n}}else i={text:s.content,footer:s.footer,templateButtons:o};const r=await a.sendMessage(e,i),{key:c}=r;return c&&(n=c.id),`true_${e}_${s}_${n}`}return`false_${e}_${s}_${n}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}_${n}`};module.exports={sendTextAsync:sendTextAsync,sendContactAsync:sendContactAsync,replyAsync:replyAsync,replyStickerAsync:replyStickerAsync,sendStickerAsync:sendStickerAsync,sendImageAsync:sendImageAsync,sendVideoAsync:sendVideoAsync,sendGifAsync:sendGifAsync,sendAudioAsync:sendAudioAsync,sendDocumentAsync:sendDocumentAsync,sendLocationAsync:sendLocationAsync,sendListAsync:sendListAsync,sendButtonAsync:sendButtonAsync,sendButtonCTAAsync:sendButtonCTAAsync};