require("dotenv").config();const{SESSION_ID:SESSION_ID}=process.env,{addMessage:addMessage,updateMessage:updateMessage,existMessage:existMessage,getMessageById:getMessageById}=require("../db.repository/messages.repository"),{findVal:findVal}=require("../common/common.util"),{LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("../common/message.type"),{signalRClient:signalRClient,serverHub:serverHub}=require("../signalr/signalr.util"),messagesUpdate=async(e,s)=>{for(const a of e){if(a.key&&"status@broadcast"==a.key.remoteJid)continue;const e=a.key.id,t=a.key.fromMe;let g=-1;if(a.update.status)switch(a.update.status){case 0:g=-1;break;case 1:g=0;break;case 2:g=1;break;case 3:g=2;break;case 4:g=3;break;case 5:g=4}let i=void 0;try{const s=await getMessageById(e);i=JSON.parse(s)}catch(e){console.log(`getMessageById::ex: ${e}`)}if(i){const a=i.key.remoteJid;let n=findVal(i,"conversation");if(!n){const e=findVal(i,"extendedTextMessage");e&&(n=e.text)}const o=getLegacyMessageType(i),c=findVal(i,"messageTimestamp");let r=s,d=a;t||(r=a,d=s);const y={id:e,sessionId:SESSION_ID,ack:g,content:n||"",type:o||"",from:r||"",to:d||"",unixTimestamp:c||0};y.type!==LegacyMessageTypes.CONTACT_MESSAGE&&y.type!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&y.type!==LegacyMessageTypes.LOCATION_MESSAGE||(y.content=""),signalRClient.connection.hub.invoke(serverHub,"MessageAck",JSON.stringify({message:JSON.stringify(y),sessionId:SESSION_ID}))}await existMessage(e)?(a.update.status=g,await updateMessage(a)):await addMessage(a)}};module.exports=messagesUpdate;