require("dotenv").config();const{SESSION_ID:SESSION_ID}=process.env,{isUrl:isUrl,isImage:isImage,isVideo:isVideo,isAudio:isAudio,keyExist:keyExist,findVal:findVal,msgContent:msgContent,vcardToJSON:vcardToJSON}=require("../common/common.util"),{LegacyMessageTypes:LegacyMessageTypes,getLegacyMessageType:getLegacyMessageType}=require("../common/message.type"),MessageMedia=require("../common/message.media"),{getAllMessageByContactId:getAllMessageByContactId,getUnreadMessage:getUnreadMessage}=require("../db.repository/messages.repository"),{getContactById:getContactById}=require("../db.repository/contacts.repository"),onSendMessageHandler=async(e,s)=>{const{sendContactAsync:t,sendTextAsync:a,replyAsync:n,replyStickerAsync:i,sendStickerAsync:o,sendImageAsync:d,sendGifAsync:g,sendVideoAsync:S,sendAudioAsync:c,sendDocumentAsync:r,sendLocationAsync:l,sendListAsync:u,sendButtonAsync:m,sendButtonCTAAsync:y}=require("../common/sock.util"),{signalRClient:I,serverHub:f}=require("../signalr/signalr.util"),N=JSON.parse(e),{sessionId:p,send_to:O,message:_,type:M,attachmentOrUrl:A,quotedMessageId:E,mentions:v}=N;if(p!==SESSION_ID)return;let T=void 0;if(A){T=(isUrl(A)?await MessageMedia.fromUrl(A):MessageMedia.fromFilePath(A)).mimetype}if("image"===M){let e=void 0;isImage(T)?e=await d(O,A,_,v,s):isVideo(T)?e=await S(O,A,_,v,s):isAudio(T)&&(e=await c(O,A,_,v,s));const t=e.toString().split("_"),[a,n,i,o]=t;"false"===a&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("gif"===M){if(isVideo(T)){const e=(await g(O,A,_,v,s)).toString().split("_"),[t,a,n,i]=e;"false"===t&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:t,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}}else if("sticker"===M){const e=JSON.parse(_);let t="";const a=(t=E?await i(O,e,E,s):await o(O,e,s)).toString().split("_"),[n,d,g,S]=a;"false"===n&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:d,message:g,messageId:S},sessionId:SESSION_ID}))}else if("videoAudio"===M){let e=void 0;isVideo(T)?e=await S(O,A,_,v,s):isAudio(T)&&(e=await c(O,A,_,v,s));const t=e.toString().split("_"),[a,n,i,o]=t;"false"===a&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("file"===M){const e=(await r(O,A,_,v,s)).toString().split("_"),[t,a,n,i]=e;"false"===t&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:t,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}else if("url"===M){let e=void 0;const t=(e=isImage(T)?await d(O,A,_,v,s):isVideo(T)?await S(O,A,_,v,s):isAudio(T)?await c(O,A,_,v,s):await r(O,A,_,v,s)).toString().split("_"),[a,n,i,o]=t;"false"===a&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("location"===M){const e=JSON.parse(_),t={degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e.description},a=(await l(O,t,v,s)).toString().split("_"),[n,i,o,d]=a;"false"===n&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else if("list"===M){const e=JSON.parse(_),t=(await u(O,e,s)).toString().split("_"),[a,n,i,o]=t;"false"===a&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("button"===M){const e=JSON.parse(_);let t=void 0;const a=(t=keyExist(e,"urlButton")||keyExist(e,"callButton")||keyExist(e,"quickReplyButton")?await y(O,e,A,s):await m(O,e,A,s)).toString().split("_"),[n,i,o,d]=a;"false"===n&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else if("vcard"===M){const e=JSON.parse(_),a=(await t(O,e,s)).toString().split("_"),[n,i,o,d]=a;"false"===n&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else{let e="";const t=(e=E?await n(O,_,E,s):await a(O,_,v,s)).toString().split("_"),[i,o,d,g]=t;"false"===i&&I.connection.hub.invoke(f,"SendMessageStatus",JSON.stringify({messageStatus:{status:i,send_to:o,message:d,messageId:g},sessionId:SESSION_ID}))}},onBroadcastMessageHandler=async(e,s,t)=>{const{sendTextAsync:a,sendContactAsync:n,sendStickerAsync:i,sendImageAsync:o,sendVideoAsync:d,sendAudioAsync:g,sendGifAsync:S,sendDocumentAsync:c,sendLocationAsync:r,sendListAsync:l,sendButtonAsync:u,sendButtonCTAAsync:m}=require("../common/sock.util"),{signalRClient:y,serverHub:I}=require("../signalr/signalr.util"),{asyncForEach:f,waitFor:N}=require("../common/common.util"),p=JSON.parse(e);await f(p,async e=>{const{sessionId:f,send_to:p,message:O,type:_,attachmentOrUrl:M,mentions:A}=e;if(f===SESSION_ID){let e=void 0;if(M){e=(isUrl(M)?await MessageMedia.fromUrl(M):MessageMedia.fromFilePath(M)).mimetype}if("image"===_){let s=void 0;isImage(e)?s=await o(p,M,O,A,t):isVideo(e)?s=await d(p,M,O,A,t):isAudio(e)&&(s=await g(p,M,O,A,t));const a=s.toString().split("_"),[n,i,S,c]=a;"false"===n&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:S,messageId:c},sessionId:SESSION_ID}))}else if("videoAudio"===_){let s=void 0;isVideo(e)?s=await d(p,M,O,A,t):isAudio(e)&&(s=await g(p,M,O,A,t));const a=s.toString().split("_"),[n,i,o,S]=a;"false"===n&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:S},sessionId:SESSION_ID}))}else if("gif"===_){if(isVideo(e)){const e=(await S(p,M,O,A,t)).toString().split("_"),[s,a,n,i]=e;"false"===s&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}}else if("sticker"===_){const e=JSON.parse(O),s=(await i(p,e,t)).toString().split("_"),[a,n,o,d]=s;"false"===a&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:o,messageId:d},sessionId:SESSION_ID}))}else if("file"===_){const e=(await c(p,M,O,A,t)).toString().split("_"),[s,a,n,i]=e;"false"===s&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:a,message:n,messageId:i},sessionId:SESSION_ID}))}else if("url"===_){let s=void 0;const a=(s=isImage(e)?await o(p,M,O,A,t):isVideo(e)?await d(p,M,O,A,t):isAudio(e)?await g(p,M,O,A,t):await c(p,M,O,A,t)).toString().split("_"),[n,i,S,r]=a;"false"===n&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:S,messageId:r},sessionId:SESSION_ID}))}else if("location"===_){const e=JSON.parse(O),s={degreesLatitude:e.latitude,degreesLongitude:e.longitude,name:e.description},a=(await r(p,s,A,t)).toString().split("_"),[n,i,o,d]=a;"false"===n&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else if("vcard"===_){const e=JSON.parse(O),s=(await n(p,e,t)).toString().split("_"),[a,i,o,d]=s;"false"===a&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else if("list"===_){const e=JSON.parse(O),s=(await l(p,e,t)).toString().split("_"),[a,n,i,o]=s;"false"===a&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}else if("button"===_){const e=JSON.parse(O);let s=void 0;const a=(s=keyExist(e,"urlButton")||keyExist(e,"callButton")||keyExist(e,"quickReplyButton")?await m(p,e,M,t):await u(p,e,M,t)).toString().split("_"),[n,i,o,d]=a;"false"===n&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:o,messageId:d},sessionId:SESSION_ID}))}else{const e=(await a(p,O,A,t)).toString().split("_"),[s,n,i,o]=e;"false"===s&&y.connection.hub.invoke(I,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:n,message:i,messageId:o},sessionId:SESSION_ID}))}await N(s)}})},onGetUnreadMessageHandler=async(e,s,t)=>{const{signalRClient:a,serverHub:n}=require("../signalr/signalr.util"),i=JSON.parse(e),{sessionId:o,limit:d}=i;if(o!==SESSION_ID)return;let g=[];const S=await getUnreadMessage(d||100);for(const e of S){const i=JSON.parse(e.message);if(!i.message)continue;if(i.key&&"status@broadcast"==i.key.remoteJid)continue;const o=i.key.fromMe,d=getLegacyMessageType(i),S=i.key.remoteJid.endsWith("@g.us");if(!o&&!S)try{await t.chatModify({markRead:!0,lastMessages:[i]},i.key.remoteJid)}catch(e){console.log(`markRead::ex: ${e}`)}const c=findVal(i,"messageTimestamp"),r=msgContent(d,i),l=i.key.remoteJid;let u=void 0;try{u=await getContactById(l)}catch(e){console.log(`getContactById::ex: ${e}`)}let m=void 0;if(S)try{m=await getContactById(i.key.participant)}catch(e){console.log(`getContactById::ex: ${e}`)}let y=void 0;if(d===LegacyMessageTypes.LOCATION_MESSAGE){const{locationMessage:e}=i.message;y={latitude:e.degreesLatitude,longitude:e.degreesLongitude,description:e.name}}let I=void 0,f=void 0;d===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?I=findVal(i,"selectedButtonId"):d===LegacyMessageTypes.LIST_RESPONSE_MESSAGE&&(f=findVal(i,"selectedRowId"));let N=s,p=l;o||(N=l,p=s);const O={id:i.key.id,sessionId:SESSION_ID,content:r||"",type:d||"",from:N||"",to:p||"",sender:S?void 0:{id:u.id?u.id:"",name:u.name?u.name:"",shortName:"",pushname:u.pushName?u.pushName:""},group:S?{id:u.id?u.id:"",name:u.name?u.name:"",sender:{id:m.id?m.id:"",name:m.name?m.name:"",shortName:"",pushname:m.pushName?m.pushName:""}}:void 0,unixTimestamp:c||0,filename:"",location:y,vcards:d===LegacyMessageTypes.CONTACT_MESSAGE||d===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,selectedButtonId:I,selectedRowId:f};if(d!==LegacyMessageTypes.CONTACT_MESSAGE&&d!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&d!==LegacyMessageTypes.LOCATION_MESSAGE||(O.content=""),d===LegacyMessageTypes.CONTACT_MESSAGE){const{vcard:e}=i.message.contactMessage;O.vcards.push(vcardToJSON(e))}if(d===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE){const{contacts:e}=i.message.contactsArrayMessage;for(const s of e)O.vcards.push(vcardToJSON(s.vcard))}g.push(O),50===g.length&&(a.connection.hub.invoke(n,"ReceiveMessages",JSON.stringify({messages:g,sessionId:SESSION_ID})),g=[])}g.push({id:"status@broadcast",type:"chat",content:"",sessionId:SESSION_ID}),g.length>0&&(a.connection.hub.invoke(n,"ReceiveMessages",JSON.stringify({messages:g,sessionId:SESSION_ID})),g=[])},onGetAllMessageHandler=async(e,s)=>{const{signalRClient:t,serverHub:a}=require("../signalr/signalr.util"),n=JSON.parse(e),{sessionId:i,phoneNumber:o,limit:d}=n;if(i!==SESSION_ID)return;let g=[];if(o){const e=await getAllMessageByContactId(o,d);for(const n of e){const e=JSON.parse(n.message);if(!e.message)continue;if(e.key&&"status@broadcast"==e.key.remoteJid)continue;const i=e.key.fromMe,o=getLegacyMessageType(e),d=e.key.remoteJid.endsWith("@g.us"),S=findVal(e,"messageTimestamp"),c=msgContent(o,e),r=e.key.remoteJid;let l=void 0;try{l=await getContactById(r)}catch(e){console.log(`getContactById::ex: ${e}`)}let u=void 0;if(d)try{u=await getContactById(e.key.participant)}catch(e){console.log(`getContactById::ex: ${e}`)}let m=void 0;if(o===LegacyMessageTypes.LOCATION_MESSAGE){const{locationMessage:s}=e.message;m={latitude:s.degreesLatitude,longitude:s.degreesLongitude,description:s.name}}let y=void 0,I=void 0;o===LegacyMessageTypes.BUTTONS_RESPONSE_MESSAGE?y=findVal(e,"selectedButtonId"):o===LegacyMessageTypes.LIST_RESPONSE_MESSAGE&&(I=findVal(e,"selectedRowId"));let f=s,N=r;i||(f=r,N=s);const p={id:e.key.id,sessionId:SESSION_ID,content:c||"",type:o||"",from:f||"",to:N||"",sender:d?void 0:{id:l.id?l.id:"",name:l.name?l.name:"",shortName:"",pushname:l.pushName?l.pushName:""},group:d?{id:l.id?l.id:"",name:l.name?l.name:"",sender:{id:u.id?u.id:"",name:u.name?u.name:"",shortName:"",pushname:u.pushName?u.pushName:""}}:void 0,unixTimestamp:S||0,filename:"",location:m,vcards:o===LegacyMessageTypes.CONTACT_MESSAGE||o===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE?[]:void 0,selectedButtonId:y,selectedRowId:I};if(o!==LegacyMessageTypes.CONTACT_MESSAGE&&o!==LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE&&o!==LegacyMessageTypes.LOCATION_MESSAGE||(p.content=""),o===LegacyMessageTypes.CONTACT_MESSAGE){const{vcard:s}=e.message.contactMessage;p.vcards.push(vcardToJSON(s))}if(o===LegacyMessageTypes.CONTACTS_ARRAY_MESSAGE){const{contacts:s}=e.message.contactsArrayMessage;for(const e of s)p.vcards.push(vcardToJSON(e.vcard))}g.push(p),50===g.length&&(t.connection.hub.invoke(a,"ReceiveMessages",JSON.stringify({messages:g,sessionId:SESSION_ID})),g=[])}g.push({id:"status@broadcast",type:"chat",content:"",sessionId:SESSION_ID}),g.length>0&&(t.connection.hub.invoke(a,"ReceiveMessages",JSON.stringify({messages:g,sessionId:SESSION_ID})),g=[])}};module.exports={onSendMessageHandler:onSendMessageHandler,onBroadcastMessageHandler:onBroadcastMessageHandler,onGetUnreadMessageHandler:onGetUnreadMessageHandler,onGetAllMessageHandler:onGetAllMessageHandler};