require("dotenv").config();const{SESSION_ID:SESSION_ID}=process.env,{getContacts:getContacts,getContactById:getContactById}=require("../db.repository/contacts.repository"),onGrabGroupHandler=async(e,n)=>{const{signalRClient:s,serverHub:t}=require("../signalr/signalr.util"),i=JSON.parse(e),{sessionId:o,groupId:r}=i;if(o!==SESSION_ID)return;const a=await n.groupFetchAllParticipating();let c=void 0;c=r?Object.entries(a).slice(0).map(e=>e[1]).filter(e=>e.id===r):Object.entries(a).slice(0).map(e=>e[1]);let d=[];for(const e of c){const n={id:e.id?e.id:"",name:e.subject?e.subject:"",sessionId:SESSION_ID};d.push(n)}d.push({id:"status@broadcast"}),s.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:d,sessionId:SESSION_ID}))},onGrabGroupAndMemberHandler=async(e,n)=>{const{signalRClient:s,serverHub:t}=require("../signalr/signalr.util"),i=JSON.parse(e),{sessionId:o,groupId:r}=i;if(o!==SESSION_ID)return;const a=await n.groupFetchAllParticipating();let c=void 0;c=r?Object.entries(a).slice(0).map(e=>e[1]).filter(e=>e.id===r):Object.entries(a).slice(0).map(e=>e[1]);let d=[];for(const e of c){let n=[];for(const s of e.participants){const e=s.id;let t=void 0;try{t=await getContactById(e)}catch(e){console.log(`getContactById::ex: ${e}`)}const i={id:e||"",name:null==t?"":t.name,pushname:null==t?"":t.pushName};i.id&&n.push(i)}const i={id:e.id?e.id:"",name:e.subject?e.subject:"",members:n,sessionId:SESSION_ID};d.push(i),1===d.length&&(s.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:d,sessionId:SESSION_ID})),d=[])}d.push({id:"status@broadcast"}),s.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:d,sessionId:SESSION_ID}))},onGrabContactHandler=async(e,n)=>{const{signalRClient:s,serverHub:t}=require("../signalr/signalr.util"),i=JSON.parse(e),{sessionId:o}=i;if(o!==SESSION_ID)return;let r=[];(await getContacts()).forEach(e=>{if(!(e.id==n)){console.log(`element: ${JSON.stringify(e)}`),console.log();const n=e.id.toString().split("@");if(n[0].length>5&&"s.whatsapp.net"===n[1]){const n={id:e.id?e.id:"",name:e.name?e.name:"",shortName:"",pushname:e.pushname?e.pushname:"",verifiedname:e.verifiedname?e.verifiedname:"",sessionId:SESSION_ID};"status@broadcast"!==n.id&&r.push(n),100===r.length&&(s.connection.hub.invoke(t,"ReceiveContacts",JSON.stringify({contacts:r,sessionId:SESSION_ID})),r=[])}}}),r.push({id:"status@broadcast"}),s.connection.hub.invoke(t,"ReceiveContacts",JSON.stringify({contacts:r,sessionId:SESSION_ID}))};module.exports={onGrabGroupHandler:onGrabGroupHandler,onGrabGroupAndMemberHandler:onGrabGroupAndMemberHandler,onGrabContactHandler:onGrabContactHandler};